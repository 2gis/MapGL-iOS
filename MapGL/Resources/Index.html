<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<style>
		html,
		body,
		#map {
			margin: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
	</style>

</head>

<body>
	<div id="map"></div>
	<script src="https://mapgl.2gis.com/api/js"></script>
	<script src="https://unpkg.com/@2gis/mapgl-clusterer@^1/dist/clustering.js"></script>
	<script>
		var objects = new Map();
		const container = document.getElementById('map');

		window.initializeMap = function(center, maxZoom, minZoom, zoom, maxPitch, minPitch, pitch, rotation, apiKey, bundleId) {
			window.map = new mapgl.Map(container, {
				center: center,
				maxZoom: maxZoom,
				minZoom: minZoom,
				zoom: zoom,
				maxPitch: maxPitch,
				minPitch: minPitch,
				pitch: pitch,
				rotation: rotation,
				zoomControl: false,
				key: apiKey
			});

			window.map.on('click', (ev) => {
				window.webkit.messageHandlers.dgsMessage.postMessage({
					type: "mapClick",
					value: ev.lngLat
				});
			});

			window.map.on('centerend', (ev) => {
				window.webkit.messageHandlers.dgsMessage.postMessage({
					type: "centerChanged",
					value: window.map.getCenter()
				});
			});

			window.map.on('zoomend', (ev) => {
				window.webkit.messageHandlers.dgsMessage.postMessage({
					type: "zoomChanged",
					value: window.map.getZoom()
				});
			});

			window.map.on('rotationend', (ev) => {
				window.webkit.messageHandlers.dgsMessage.postMessage({
					type: "rotationChanged",
					value: window.map.getRotation()
				});
			});

			window.map.on('pitchend', (ev) => {
				window.webkit.messageHandlers.dgsMessage.postMessage({
					type: "pitchChanged",
					value: window.map.getPitch()
				});
			});
		}

		window.addMarker = function (id, markerOptions) {
			const marker = new mapgl.Marker(window.map, markerOptions);
			objects.set(id, marker);
			marker.on('click', (ev) => {
				window.webkit.messageHandlers.dgsMessage.postMessage({
					type: "markerClick",
					value: id
				});
			});
		}
		window.addCluster = function (id, radius, markers) {
			const clusterer = new mapgl.Clusterer(window.map, {
				radius: radius,
			});
			clusterer.on('click', (event) => {
				alert(`${event.target} is clicked`);
			});
			clusterer.load(markers);
		}
		window.hideMarker = function (id) {
			const marker = objects.get(id);
			marker.hide();
		}

		window.showMarker = function (id) {
			const marker = objects.get(id);
			marker.show();
		}

		window.setMarkerCoordinates = function (id, coordinates) {
			const marker = objects.get(id);
			marker.setCoordinates(coordinates);
		}

		window.addPolygon = function (points, id, strokeWidth, color, strokeColor, zIndex) {
			const polygon = new mapgl.Polygon(window.map, {
				coordinates: points,
				strokeWidth: strokeWidth,
				color: color,
				strokeColor: strokeColor,
				zIndex: zIndex,
			});
			objects.set(id, polygon);
		}
		window.destroyObject = function (id) {
			const object = objects.get(id);
			object.destroy();
			objects.delete(id);
		}
		window.addCircle = function (center, radius, id, strokeWidth, color, strokeColor, zIndex) {
			const circle = new mapgl.Circle(window.map, {
				coordinates: center,
				radius: radius,
				color: color,
				strokeWidth: strokeWidth,
				strokeColor: strokeColor,
				zIndex: zIndex,
			});
			objects.set(id, circle);
		}
		window.addPolyline = function (id, coordinates, color, width, zIndex, color2, width2, zIndex2, color3, width3, zIndex3) {
			const polyline = new mapgl.Polyline(window.map, {
				coordinates: coordinates,
				color: color,
				width: width,
				zIndex: zIndex,
				color2: color2,
				width2: width2,
				zIndex2: zIndex2,
				color3: color3,
				width3: width3,
				zIndex3: zIndex3,
			});
			objects.set(id, polyline);
		}
		window.onerror = (msg, url, line, column, error) => {
			const message = {
				message: msg,
				url: url,
				line: line,
				column: column,
				error: JSON.stringify(error)
			}
			if (window.webkit) {
				window.webkit.messageHandlers.error.postMessage(message);
			} else {
				console.log("Error:", message);
			}
		};
		window.addEventListener('resize', () => window.map.invalidateSize());

	</script>
</body>

</html>
